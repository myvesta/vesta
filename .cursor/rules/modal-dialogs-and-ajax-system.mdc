# myVesta Modal Dialogs and AJAX Communication System

This rule defines the complete system for creating modal dialogs (Floating Div forms) and AJAX communication in the myVesta web interface. This system allows you to create button actions like "Install WordPress" that open modal dialogs and handle multi-step AJAX workflows.

## System Architecture Overview

The modal dialogs system consists of:

1. **Frontend Components**:
   - HTML structure in [web/templates/header.html](mdc:web/templates/header.html)
   - JavaScript logic in [web/js/floating-div.js](mdc:web/js/floating-div.js)
   - Dataset values in list templates (e.g., [web/templates/user/list_web.html](mdc:web/templates/user/list_web.html))

2. **Backend Components**:
   - Authentication check in [web/ajax/authentication_check.php](mdc:web/ajax/authentication_check.php)
   - Form element helpers in [web/inc/form-elements.php](mdc:web/inc/form-elements.php)
   - AJAX endpoint scripts in [web/ajax/](mdc:web/ajax/)

3. **Security Layer**:
   - CSRF token validation in [web/ajax/authentication_check.php](mdc:web/ajax/authentication_check.php)
   - User authentication check in [web/ajax/authentication_check.php](mdc:web/ajax/authentication_check.php) via `include($_SERVER['DOCUMENT_ROOT']."/inc/main.php");`
   - Domain ownership verification in [web/ajax/authentication_check.php](mdc:web/ajax/authentication_check.php): both `$_REQUEST['dataset']['domain']` and `$_REQUEST['domain']` will be checked to see if they belong to `$myvesta_logged_user`
   - Required parameter validation in [web/ajax/authentication_check.php](mdc:web/ajax/authentication_check.php) via optional `$authentication_check_required_param`
   - Compare if optional `$authentication_check_match_user` variable is equal to logged user in [web/ajax/authentication_check.php](mdc:web/ajax/authentication_check.php)

## Frontend Components

### 1. HTML Structure (header.html)

The system uses two main modal containers defined in [web/templates/header.html](mdc:web/templates/header.html):

#### Floating Center Div (Main Modal)
```html
<div id="floating-center-div" style="position: fixed; top: 50%; left: 50%; ...">
    <div id="floating-center-div-right-close">...</div>
    <h1 id="floating-center-div-title"></h1>
    <div id="floating-center-div-content"></div>
</div>
```

**Purpose**: Main modal dialog for displaying forms and content.

**Key Elements**:
- `#floating-center-div-title` - Modal title
- `#floating-center-div-content` - Modal content (forms, messages, etc.)
- `#floating-center-div-right-close` - Close button

#### Confirm Div (Reusable Elements)
```html
<div id="confirm-div">
    <h1 id="confirm-div-title"></h1>
    <div id="confirm-div-content"></div>
    <div id="confirm-div-content-input">...</div>
    <div id="confirm-div-content-textarea">...</div>
    <div id="confirm-div-content-listbox">...</div>
    <div id="confirm-div-content-checkbox">...</div>
    <div id="confirm-div-buttons-confirm">...</div>
    <div id="confirm-div-buttons-notify">...</div>
    <div id="confirm-div-button">...</div>
</div>
```

**Purpose**: Template container for reusable form elements (not directly displayed, used by form-elements.php).

**Available Element Types**:
- `input` - Text input field
- `textarea` - Multi-line text area
- `listbox` - Dropdown/select box
- `checkbox` - Checkbox input
- `button` - Single button
- `buttons_confirm` - Yes/No confirmation buttons
- `buttons_notify` - OK notification button

### 2. Dataset Values Array

In list templates (e.g., [web/templates/user/list_web.html](mdc:web/templates/user/list_web.html)), define a dataset array for each item:

```html
<script>
  var dataset_values = [];
</script>

<?php foreach ($data as $key => $value) { ?>
  <script>
    dataset_values[<?=$i?>] = {
      'url': '/ajax/web/index.php',
      'title': '<?=$key?>',
      'domain': '<?=$key?>',
      'web_template': '<?=$data[$key]['TPL']?>',
      'proxy_template': '<?=$data[$key]['PROXY']?>',
      'backend_template': '<?=$data[$key]['BACKEND']?>',
      'ssl_support': '<?=$data[$key]['SSL']?>',
      'letsencrypt_support': '<?=$data[$key]['LETSENCRYPT']?>'
    };
  </script>
<?php } ?>
```

**Key Properties**:
- `url` - The AJAX endpoint to call (usually index.php)
- `title` - Modal title to display
- Additional properties - Any data needed by the AJAX endpoint

### 3. Trigger Button

Add a button that calls `more_button_click()`:

```html
<div class="actions-panel__col">
    <a href="javascript:void(0)" onclick="more_button_click(<?=$i?>)">
        <?=__('WordPress')?>&nbsp;&nbsp;&nbsp; <i></i>
    </a>
</div>
```

**Parameters**:
- Pass the index `$i` that corresponds to the dataset_values array
- OR pass an object directly: `more_button_click({url: '...', title: '...', ...})`

### 4. JavaScript Functions (floating-div.js)

#### Core Functions

**showFloatingDiv(title, contentHtml)**
- Shows the modal dialog
- Sets title and content
- Fades in with animation

**hideFloatingDiv()**
- Hides the modal dialog
- Clears spawned process intervals
- Fades out with animation

**more_button_click(id)**
- Main entry point for button actions
- Accepts array index or object
- Makes initial AJAX request to load form
- Displays loading state

```javascript
function more_button_click(id) {
    if (typeof id != 'object') {
        var url = dataset_values[id].url;
        var title = dataset_values[id].title;
    } else {
        var url = id.url;
        var title = id.title;
    }
    
    $.ajax({
        url: url,
        type: 'POST',
        data: { dataset: dataset_values[id], token: GLOBAL.TOKEN },
        success: function(response) {
            showFloatingDiv(title, response);
        }
    });
}
```

**send_ajax_request()**
- Handles form submission
- Serializes form data
- Captures which button was clicked
- Sends AJAX POST request
- Updates modal with response

#### Long-Running Process Functions

**startWatchingSpawnedAjaxProcess(user, hash)**
- Starts polling for process output
- Updates textarea with real-time output
- Returns interval ID

**clearSpawnedAjaxProcessInterval()**
- Stops polling interval
- Shows copy-to-clipboard button
- Cleans up process markers

**run_ajax_call_for_spawned_ajax_process(user, hash)**
- Makes AJAX call to check process status
- Updates textarea with output
- Stops polling when process completes

#### Event Handlers

```javascript
// ESC key closes modal
$(document).on('keydown', function(e) {
    if (e.key === "Escape" && FloatingDivOpened) hideFloatingDiv();
});

// Close button
$('#floating-center-div-right-close').on('click', function() {
    hideFloatingDiv();
});

// Form submission
$("#floating-center-div").on("submit", "#floating-center-div-form", function(e) {
    e.preventDefault();
    send_ajax_request();
});
```

## Backend Components

### 1. Authentication Check (authentication_check.php)

**ALWAYS** include this at the beginning of every AJAX endpoint:

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;               // This means that the script is called directly via AJAX
$authentication_check_required_param['dataset']['domain'] = true;  // Define required parameters
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");
```

**What it does**:
1. Includes main.php for core functions
2. Validates CSRF token (`$_POST['token']` vs `$_SESSION['token']`)
3. Validates required parameters exist
4. Verifies domain ownership if domain parameter exists
5. Sets `$myvesta_logged_user` variable (handles user impersonation)
6. Dies with error message if any check fails

**Setting Required Parameters**:

```php
// Require domain in dataset
$authentication_check_required_param['dataset']['domain'] = true;

// Require multiple dataset fields
$authentication_check_required_param['dataset']['domain'] = true;
$authentication_check_required_param['dataset']['database'] = true;

// Require direct parameter
$authentication_check_required_param['domain'] = true;

// Match specific user (admin-only endpoint)
$authentication_check_match_user = 'admin';
```

**Available Variables After Include**:
- `$myvesta_logged_user` - Current user (handles look/impersonation)
- `$domain` - Domain name if required
- `$authentication_check_loaded` - Flag to check if included

### 2. Form Element Functions (form-elements.php)

Include after authentication check:

```php
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");
```

#### myvesta_open_form($action = '')

Opens a form with CSRF token.

```php
echo myvesta_open_form('/ajax/web/router.php'); // send form to router.php
```

**Parameters**:
- `$action` - Form action URL (defaults to current URI)

**Returns**: Opening form tag with hidden token field

#### myvesta_close_form()

Closes the form.

```php
echo myvesta_close_form();
```

**Returns**: Closing form tag

#### myvesta_get_hidden_fields($hidden_fields = array())

Preserves dataset and adds additional hidden fields.

```php
// Preserve all dataset fields
echo myvesta_get_hidden_fields();

// Preserve dataset + add custom fields
echo myvesta_get_hidden_fields(array(
    'wordpress_install' => '1',
    'custom_field' => 'value'
));

// Override dataset field
echo myvesta_get_hidden_fields(array(
    'dataset' => array('domain' => 'newdomain.com')
));
```

**Parameters**:
- `$hidden_fields` - Associative array of field names and values

**Returns**: HTML hidden input fields

#### myvesta_get_element($element_name, $label, $variable_name, $variable_value, $selected_value, $style, $replace_or_add_style)

Creates form elements from templates in header.html.

**Element Types**:

##### Input Field
```php
echo myvesta_get_element(
    'input',                    // Element type
    'Username:',                // Label text
    'username',                 // Field name
    'defaultvalue',             // Default value
    null,                       // Not used for input
    'width: 300px;',            // CSS style
    'replace'                   // replace or add
);
```

##### Textarea
```php
echo myvesta_get_element(
    'textarea',
    'Description:',
    'description',
    'Default text content',
    null,
    'width: 400px; height: 200px;'
);
```

##### Listbox (Dropdown)
```php
echo myvesta_get_element(
    'listbox',
    'Select Template:',
    'template',
    array(                      // Options array
        'PHP-FPM-82' => 'PHP-FPM 8.2',
        'PHP-FPM-81' => 'PHP-FPM 8.1',
        'default' => 'Default'
    ),
    'PHP-FPM-82',              // Selected value
    'width: 300px;'
);
```

##### Checkbox
```php
echo myvesta_get_element(
    'checkbox',
    'Enable SSL',
    'ssl_enabled',
    'yes',                      // checked (yes/no, 1/0, true/false)
    null,
    'margin-top: 10px;'
);
```

##### Single Button
```php
echo myvesta_get_element(
    'button',
    '',                         // Label not used for button
    'wordpress_install',        // Button name
    'Install WordPress',        // Button text
    null,
    'width: 200px;',
    'add'                       // Add to existing styles
);
```

##### Confirmation Buttons (Yes/No)
```php
echo myvesta_get_element(
    'buttons_confirm',
    '',
    'Yes/No',                   // Button names (slash-separated)
    __('Yes').'/'.__('No'),     // Button labels (slash-separated)
    null,
    ''
);
```

**Parameters**:
- `$element_name` - Type: 'input', 'textarea', 'listbox', 'checkbox', 'button', 'button_gray', 'buttons_confirm'
- `$label` - Label text (shown before element)
- `$variable_name` - HTML name attribute
- `$variable_value` - Default value or options array (for listbox)
- `$selected_value` - Selected value (for listbox only)
- `$style` - CSS style string
- `$replace_or_add_style` - 'replace' or 'add' (default: 'replace')

#### myvesta_get_disabled_textarea($value, $style, $copy_to_clipboard, $close_button, $watch_spawned_ajax_process, $user, $hash)

Creates a disabled textarea with optional copy-to-clipboard and real-time process watching.

```php
// Simple output display
echo myvesta_get_disabled_textarea(
    'Command output here',
    '',                         // Default style
    true,                       // Show copy button
    true,                       // Show close button
    false                       // No process watching
);

// Watch spawned process (for long-running tasks)
echo myvesta_get_disabled_textarea(
    '',                         // Initially empty
    '',
    true,                       // Show copy button
    true,                       // Show close button
    true,                       // Enable process watching
    $myvesta_logged_user,
    $hash                       // Process hash from v-spawn-ajax-process
);
```

**Parameters**:
- `$value` - Initial text content
- `$style` - CSS style (defaults to monospace textarea style)
- `$copy_to_clipboard` - Show copy-to-clipboard button (true/false)
- `$watch_spawned_ajax_process` - Enable real-time output watching (true/false)
- `$user` - Username (required if watching process)
- `$hash` - Process hash (required if watching process)

**Returns**: Textarea HTML + optional buttons + optional JavaScript

#### myvesta_hide_floating_div()

Closes the modal dialog and exits script.

```php
if (isset($_POST['No'])) {
    myvesta_hide_floating_div();
}
```

**Behavior**: Outputs JavaScript to hide modal and calls exit()

### 3. Multi-Step AJAX Workflow Pattern

The recommended pattern is to use index.php, router.php, and action-specific files in `actions/` folder.

#### Step 1: Initial Form (index.php)

Shows the initial form/buttons to the user.

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");

// Display form
echo myvesta_open_form('/ajax/web/wordpress/router.php'); // send form to router.php
echo myvesta_get_hidden_fields();
echo myvesta_get_element('button_gray', '', 'wordpress_install', __('Install WordPress'), null, 'width: 200px;', 'add');
echo myvesta_close_form();

exit;
?>
```

**Purpose**:
- Loaded by `more_button_click()`
- Receives `dataset` array via POST
- Shows initial options/buttons
- Form submits to router.php

#### Step 2: Action Router (router.php)

Routes to specific action handlers based on button clicked.

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");

// Check which button was clicked
if (!empty($_POST['wordpress_install'])) {
    // Nested sub-script for WordPress installation
    include ($_SERVER['DOCUMENT_ROOT']."/ajax/web/wordpress/actions/install.php");
    exit;
}

if (!empty($_POST['another_action'])) {
    // Nested sub-script for Another action
    include ($_SERVER['DOCUMENT_ROOT']."/ajax/web/another/action.php");
    exit;
}

echo 'No action selected';
exit;
?>
```

**Purpose**:
- Receives form submission from index.php
- Routes to appropriate action file
- Can have multiple action handlers

#### Step 3: Action Handler (wordpress/install.php)

Executes the actual action with confirmations if needed.

```php
<?php

// Nested sub-script for WordPress installation

$authentication_check_this_is_nested_script = true;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Check if confirmation needed
//  Always use escapeshellarg for all arguments to avoid shell injection
$is_empty_public_html=exec(VESTA_CMD."v-check-if-public-html-is-empty ".escapeshellarg($user)." ".escapeshellarg($domain), $output, $return_var);

$run_action = false;

if ($is_empty_public_html == '0') {
    // Directory not empty, ask for confirmation
    if (!isset($_POST['Yes']) && !isset($_POST['No'])) {
        echo myvesta_open_form('/ajax/web/wordpress/router.php'); // send form to router.php
        echo __('There are previously files in the domain directory').'.<br />';
        echo __('Are you sure you want to override them').'?<br /><br />';
        echo myvesta_get_hidden_fields(array(
            'wordpress_install' => '1' // action for router.php
            )); // Preserve action
        echo myvesta_get_element('buttons_confirm', '', 'Yes/No', __('Yes').'/'.__('No'));
        echo myvesta_close_form();
        exit;
    } else {
        if (isset($_POST['Yes'])) {
            $run_action = true;
        } elseif (isset($_POST['No'])) {
            myvesta_hide_floating_div();
        }
    }
}

if ($is_empty_public_html == '1') {
    $run_action = true;
}

if ($run_action) {
    // Execute action using v-spawn-ajax-process for long-running tasks
    $output='';
    $exec_output='';
    // Always use escapeshellarg for all arguments to avoid shell injection
    $cmd = VESTA_CMD."v-spawn-ajax-process ".escapeshellarg($myvesta_logged_user)." /usr/local/vesta/bin/v-install-wordpress ".escapeshellarg($domain);
    $exec_output = shell_exec($cmd);
    $output=__('WordPress installation output').':';
    echo '<b>'.$output.'</b><br /><br />';
    $hash = trim($exec_output);
    echo myvesta_get_disabled_textarea('', '', true, true, true, $myvesta_logged_user, $hash);
    exit;
}
?>
```

**Purpose**:
- Performs the actual action
- Can show confirmation dialogs
- Handles Yes/No responses
- Executes commands
- Shows output with real-time updates

**Key Patterns**:
1. **Check authentication**: `include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");`
2. **Conditional confirmation**: Ask for confirmation if needed
3. **Preserve form state**: Use `myvesta_get_hidden_fields()` to maintain action context
4. **Long-running tasks**: Use `v-spawn-ajax-process` + `myvesta_get_disabled_textarea()` with watching enabled

## Security Best Practices

### 1. CSRF Token
- **Always** send `GLOBAL.TOKEN` in AJAX requests
- Backend validates via authentication_check.php
- Token is in `$_SESSION['token']`

### 2. Domain Ownership
- Set `$authentication_check_this_is_nested_script = false;` if PHP script is called directly via AJAX
- Set `$authentication_check_this_is_nested_script = true;` if PHP script is sub-script of previously loaded PHP script
- Set `$authentication_check_required_param['dataset']['important_POST_field_or_variable'] = true`
- Add `include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");` so authentication_check.php can verify ownership
- If an field includes another domain in the action, check ownership of that domain as well: `$domain2 = $_POST['domain2']; check_if_domain_is_owned_by_user($domain2, $myvesta_logged_user);`
- These steps will prevent users from accessing other users' domains

### 3. Required Parameters
- Define all required parameters before including authentication_check.php
- Script dies if parameters are missing
- Helps prevent undefined variable errors

### 4. User Impersonation
- Use `$myvesta_logged_user` instead of `$_SESSION['user']`
- Handles admin impersonating other users
- Always use for command execution

### 5. Admin-Only Endpoints
```php
// Authentication checks
$authentication_check_match_user = 'admin';
$authentication_check_this_is_nested_script = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");
```

## Complete Examples

### Example 1: Simple Action Button

**Step 1**: Add dataset to list template

```html
<script>
  dataset_values[<?=$i?>] = {
    'url': '/ajax/database/index.php',
    'title': 'Database: <?=$key?>',
    'database_name': '<?=$key?>'
  };
</script>

<a onclick="more_button_click(<?=$i?>)"><?=__('Manage Database')?></a>
```

**Step 2**: Create web/ajax/database/index.php

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['database_name'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");

echo myvesta_open_form('/ajax/database/router.php'); // send form to router.php
echo myvesta_get_hidden_fields();
echo myvesta_get_element('button_gray', '', 'database_backup', __('Backup'), null, 'width: 200px;', 'add');
echo myvesta_close_form();
exit;
?>
```

**Step 3**: Create web/ajax/database/router.php

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['database_name'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");

if (!empty($_POST['database_backup'])) {
    // Nested sub-script for database backup
    include ($_SERVER['DOCUMENT_ROOT']."/ajax/database/actions/backup.php");
    exit;
}

echo 'No action selected';
exit;
?>
```

**Step 4**: Create web/ajax/database/actions/backup.php

```php
<?php

// Nested sub-script for database backup

// Authentication checks
$authentication_check_this_is_nested_script = true;
$authentication_check_required_param['dataset']['database_name'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Set $database_name variable
$database_name = $_REQUEST['dataset']['database_name'];

// Execute action using v-spawn-ajax-process for long-running tasks
$output='';
$exec_output='';
// Always use escapeshellarg for all arguments to avoid shell injection
$cmd = VESTA_CMD."v-spawn-ajax-process ".escapeshellarg($myvesta_logged_user)." /usr/local/vesta/bin/v-backup-database ".escapeshellarg($myvesta_logged_user)." ".escapeshellarg($database_name);
$exec_output = shell_exec($cmd);
$output=__('Database dump output').':';
echo '<b>'.$output.'</b><br /><br />';
$hash = trim($exec_output);
echo myvesta_get_disabled_textarea('', '', true, true, true, $myvesta_logged_user, $hash);
exit;
?>
```

### Example 2: Form with two steps, first step contains Input field, second step contains Confirmation and Execution

**Step 1**: Create web/ajax/web/subdomain/index.php with form

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");

echo myvesta_open_form('/ajax/web/subdomain/router.php'); // send form to router.php
echo myvesta_get_hidden_fields();
echo myvesta_get_element('button_gray', '', 'subdomain_create_step1', __('Create subdomain'), null, 'width: 200px;', 'add');
echo myvesta_close_form();
exit;
?>
```

**Step 2**: Create web/ajax/web/subdomain/router.php (router script)

```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");

if (!empty($_POST['subdomain_create_step1'])) {
    // Nested sub-script for creating a subdomain, step1
    include ($_SERVER['DOCUMENT_ROOT']."/ajax/web/subdomain/actions/create_step1.php");
    exit;
}

if (!empty($_POST['subdomain_create_step2'])) {
    // Nested sub-script for creating a subdomain, step2
    include ($_SERVER['DOCUMENT_ROOT']."/ajax/web/subdomain/actions/create_step2.php");
    exit;
}

echo 'No action selected';
exit;
?>
```

**Step 2**: Create web/ajax/web/subdomain/actions/create_step1.php with 'subdomain' field (step 1)

```php
<?php

// Nested sub-script for creating a subdomain

// Authentication checks
$authentication_check_this_is_nested_script = true;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

echo myvesta_open_form('/ajax/web/subdomain/router.php'); // send form to router.php
echo __('Create subdomain for domain').': <b>'.$domain.'</b><br /><br />';
echo myvesta_get_hidden_fields();
echo myvesta_get_element('input', __('Subdomain name:'), 'subdomain', '', null, 'width: 300px;');
echo myvesta_get_element('button', '', 'subdomain_create_step2', __('Create subdomain'), null, 'width: 200px;', 'add');
echo myvesta_close_form();
exit;
?>
```

**Step 2**: Create web/ajax/web/subdomain/actions/create_step2.php with confirmation and action execution (step 2)

```php
<?php

// Nested sub-script for creating subdomains

// Authentication checks
$authentication_check_this_is_nested_script = true;
$authentication_check_required_param['dataset']['domain'] = true;
$authentication_check_required_param['subdomain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Get $subdomain variable
$subdomain = $_POST['subdomain'];

// Validate input
if (empty($subdomain)) {
    echo '<span style="color: red;">'.__('Subdomain name cannot be empty').'</span>';
    exit;
}

// Ask for confirmation
if (!isset($_POST['Yes']) && !isset($_POST['No'])) {
    echo myvesta_open_form('/ajax/web/subdomain/router.php'); // send form to router.php
    echo __('Create subdomain').': <b>'.$subdomain.'.'.$domain.'</b>?<br /><br />';
    echo myvesta_get_hidden_fields(array(
        'subdomain_create_step2' => '1',  // action for router.php
        'subdomain' => $subdomain         // repeating field from step 1
    ));
    echo myvesta_get_element('buttons_confirm', '', 'Yes/No', __('Yes').'/'.__('No'));
    echo myvesta_close_form();
    exit;
}

if (isset($_POST['No'])) {
    myvesta_hide_floating_div();
}

if (isset($_POST['Yes'])) {
    // Execute command
    // Always use escapeshellarg for all arguments to avoid shell injection
    $cmd = VESTA_CMD."v-add-web-domain-alias ".escapeshellarg($myvesta_logged_user)." ".escapeshellarg($domain)." ".escapeshellarg($subdomain);
    exec($cmd, $output, $return_var);
    
    if ($return_var == 0) {
        echo '<h2>'.__('Success').'</h2>';
        echo __('Subdomain created').': <b>'.$subdomain.'.'.$domain.'</b>';
    } else {
        echo '<h2>'.__('Error').'</h2>';
        echo implode('<br />', $output);
    }
}
exit;
?>
```

### Example 3: Long-Running Process with Real-Time Output

**web/ajax/web/wordpress/actions/lock.php: execute with process spawning**

```php
<?php

// Nested sub-script for WordPress locking

// Authentication checks
$authentication_check_this_is_nested_script = true;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Check if WordPress is installed
//  Always use escapeshellarg for all arguments to avoid shell injection
$is_wordpress_installed=exec(VESTA_CMD."v-check-if-wordpress-is-installed ".escapeshellarg($user)." ".escapeshellarg($domain), $output, $return_var);
if ($is_wordpress_installed == '0') {
    // WordPress is not installed
    echo __('The WordPress is not installed').'.<br /><br />';
    echo myvesta_get_close_button();
    exit;
}

// Check if WordPress is locked
//  Always use escapeshellarg for all arguments to avoid shell injection
$is_wordpress_locked=exec(VESTA_CMD."v-check-if-wordpress-is-locked ".escapeshellarg($user)." ".escapeshellarg($domain), $output, $return_var);
if ($is_wordpress_locked=='1') {
    // WordPress is locked
    echo __('The WordPress is already locked').'.<br /><br />';
    echo myvesta_get_close_button();
    exit;
}

// Execute action using v-spawn-ajax-process for long-running tasks
$output='';
$exec_output='';
// Always use escapeshellarg for all arguments to avoid shell injection
$cmd = VESTA_CMD."v-spawn-ajax-process ".escapeshellarg($myvesta_logged_user)." /usr/local/vesta/bin/v-lock-wordpress ".escapeshellarg($domain);
$exec_output = shell_exec($cmd);
$output=__('WordPress locking output').':';
echo '<b>'.$output.'</b><br /><br />';
$hash = trim($exec_output);
echo myvesta_get_disabled_textarea('', '', false, true, true, $myvesta_logged_user, $hash, 100);
exit;
```

**Notes on v-spawn-ajax-process**:
- Returns a hash that identifies the process
- Process output is captured in real-time
- Frontend polls every second using `startWatchingSpawnedAjaxProcess()`
- When process completes, polling stops and copy-to-clipboard button appears
- Use for commands that take more than a few seconds

## File Structure Example

For a complete feature like "WordPress tools", organize files like this:

```
web/ajax/web/wordpress/
├── index.php              # Initial form with action buttons
├── router.php             # Action router
└── actions/
    ├── install.php        # WordPress installation
    ├── lock.php           # WordPress locking
    ├── unlock.php         # WordPress unlocking
    ├── clone_step1.php    # WordPress clonning step1
    └── clone_step2.php    # WordPress clonning step2
```

## Common Pitfalls

### 1. Forgetting to Include Authentication Check
**Wrong**:
```php
<?php

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");
```

**Correct**:
```php
<?php

// Authentication checks
$authentication_check_this_is_nested_script = false;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Form elements include
include($_SERVER['DOCUMENT_ROOT']."/inc/form-elements.php");
```

### 2. Not Checking Authentication in nested sub-srcipts like [web/ajax/web/wordpress/actions/install.php](mdc:web/ajax/web/wordpress/actions/install.php)
**Wrong**:
```php

// Nested sub-script for WordPress installation

// Execute action
```

**Correct**:
```php

// Nested sub-script for WordPress installation

// Authentication checks
$authentication_check_this_is_nested_script = true;
$authentication_check_required_param['dataset']['domain'] = true;
include($_SERVER['DOCUMENT_ROOT']."/ajax/include_authentication_check.php");

// Execute action
```

### 3. Not using the PHP escapeshellarg(...) function for command arguments that will be executed with exec(...) or shell_exec(...)
**Wrong**:
```php
$cmd = VESTA_CMD."v-spawn-ajax-process $myvesta_logged_user /usr/local/vesta/bin/v-install-wordpress $domain";
$exec_output = shell_exec($cmd);
```

**Correct**:
```php
$cmd = VESTA_CMD."v-spawn-ajax-process ".escapeshellarg($myvesta_logged_user)." /usr/local/vesta/bin/v-install-wordpress ".escapeshellarg($domain);
$exec_output = shell_exec($cmd);
```

### 4. Not Preserving Hidden Fields in Confirmation Dialogs
**Wrong**:
```php
echo myvesta_open_form('/ajax/web/wordpress/router.php');
echo myvesta_get_element('buttons_confirm', '', 'Yes/No', __('Yes').'/'.__('No'));
echo myvesta_close_form();
```

**Correct**:
```php
echo myvesta_open_form('/ajax/web/wordpress/router.php'); // send form to router.php
echo myvesta_get_hidden_fields(array(
    'wordpress_install' => '1' // action for router.php
    ));  // Preserve action
echo myvesta_get_element('buttons_confirm', '', 'Yes/No', __('Yes').'/'.__('No'));
echo myvesta_close_form();
```

### 5. Using Wrong User Variable
**Wrong**:
```php
$cmd = VESTA_CMD."v-delete-web-domain ".escapeshellarg($_POST'user'])." ".escapeshellarg($domain);
```

**Correct**:
```php
$cmd = VESTA_CMD."v-delete-web-domain ".escapeshellarg($myvesta_logged_user)." ".escapeshellarg($domain);
```

### 6. Forgetting to Exit After Output
**Wrong**:
```php
echo 'Success!';
// Script continues, may cause issues
```

**Correct**:
```php
echo 'Success!';
exit;
```

## Styling and UX Best Practices

### 1. Use Consistent Button Styles
```php
// First action
echo myvesta_get_element('button_gray', '', 'action_name_for_install', __('Install'), null, 'width: 200px;', 'add');

// Second action
echo myvesta_get_element('button_gray', '', 'action_name_for_update', __('Update'), null, 'width: 200px;', 'add');

// Third action
echo myvesta_get_element('button_gray', '', 'action_name_for_delete', __('Delete'), null, 'width: 200px;', 'add');
```

### 2. Show Clear Loading States
The system automatically shows "Loading... Please wait..." with opacity effect when making AJAX requests.

### 3. Use Confirmation for Destructive Actions
Always ask for confirmation before:
- Deleting data
- Overwriting files
- Making irreversible changes

### 4. Provide Informative Success/Error Messages
```php
if ($return_var == 0) {
    echo '<h2 style="color: #27c24c;">'.__('Success').'</h2>';
    echo '<p>'.__('WordPress has been successfully installed').'.</p>';
    echo '<p><a href="http://'.$domain.'" target="_blank">'.__('Visit your website').'</a></p>';
} else {
    echo '<h2 style="color: #ff6b6b;">'.__('Error').'</h2>';
    echo '<p>'.__('Installation failed').':</p>';
    echo '<pre>'.implode("\n", $output).'</pre>';
}
```

## Translation Support

All user-facing text should use the `__()` function for translation:

```php
echo __('Install WordPress');
echo __('Are you sure you want to continue?');
echo __('Success');
echo __('Error');
```

For strings with variables:
```php
echo __('Installing WordPress on %s', $domain);
echo __('Database %s backed up successfully', $database);
```

## Testing Checklist

When creating a new button action:

- [ ] Dataset values correctly defined in list template
- [ ] Button calls `more_button_click()` with correct index
- [ ] CSRF token sent in all AJAX requests
- [ ] index.php defines required parameters
- [ ] index.php set `$authentication_check_this_is_nested_script = false;`
- [ ] index.php set `$authentication_check_required_param['dataset']['important_POST_field_or_variable'] = true;`
- [ ] index.php includes `include_authentication_check.php`
- [ ] index.php displays form with correct action URL
- [ ] index.php add hidden fields
- [ ] router.php defines required parameters
- [ ] router.php set `$authentication_check_this_is_nested_script = false;`
- [ ] router.php set `$authentication_check_required_param['dataset']['important_POST_field_or_variable'] = true;`
- [ ] router.php includes `include_authentication_check.php`
- [ ] router.php routes to correct action file
- [ ] actions/execute.php as nested sub-script set `$authentication_check_this_is_nested_script = true;`
- [ ] actions/execute.php set `$authentication_check_required_param['dataset']['important_POST_field_or_variable'] = true;`
- [ ] actions/execute.php includes `include_authentication_check.php`
- [ ] actions/execute.php runs shell commands like `$cmd = VESTA_CMD."v-spawn-ajax-process ".escapeshellarg($myvesta_logged_user)." /usr/local/vesta/bin/v-install-wordpress ".escapeshellarg($domain);`
- [ ] Using `$myvesta_logged_user` instead of `$user`
- [ ] All scripts end with `exit;`
- [ ] Always use `escapeshellarg($variable)` for all arguments to avoid shell injection
- [ ] Long-running tasks use `v-spawn-ajax-process`
- [ ] Success/error messages are clear and translated
- [ ] Confirmation shown for destructive actions
- [ ] ESC key closes modal properly
- [ ] Works when admin is impersonating user

## Additional Resources

- Main PHP functions: [web/inc/main.php](mdc:web/inc/main.php)
- Translation function `__()`: [web/inc/i18n.php](mdc:web/inc/i18n.php)
- Command constants: `VESTA_CMD` defined in [web/inc/main.php](mdc:web/inc/main.php)

## Summary Workflow

1. **User clicks button** → `more_button_click(index)` called
2. **JavaScript sends AJAX request** → `dataset_values[index]` sent to `index.php`
3. **index.php validates** → Shows form/buttons
4. **User submits form** → `send_ajax_request()` posts to `router.php`
5. **router.php routes** → Includes appropriate action file
6. **Action file executes** → May show confirmation or run command
7. **Result displayed** → Success/error message or real-time output
8. **User closes modal** → ESC key or close button

This pattern allows for:
- Clean separation of concerns
- Reusable action endpoints
- Multi-step confirmations
- Real-time process monitoring
- Consistent security checks
- Easy maintenance and extension
