---
description: myVesta modal dialogs (Floating Div forms) and AJAX Communication Patterns in myVesta web interface
globs: web/js/floating-div.js,web/templates/*.html,web/ajax/authentication_check.php,web/ajax/**/*.php
---

# myVesta modal dialogs (Floating Div forms) and AJAX Communication

This rule documents the modal dialogs (floating div forms) used in myVesta web interface for AJAX form communication.

## Floating Div Structure

### HTML Container
The floating div is defined in [web/templates/header.html](mdc:web/templates/header.html) at lines 53-59:

```html
  <div id="floating-center-div" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50vw; max-width: 700px; background: #fff; z-index: 9999; box-shadow: 0 4px 32px rgba(0,0,0,0.6); border-radius: 8px; padding: 32px 24px; display: none;">
    <div id="floating-center-div-right-close" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #999;">
      <i class="fas fa-times"></i>
    </div>
    <h1 id="floating-center-div-title" style="margin-top: 0;"></h1>
    <div id="floating-center-div-content"></div>
  </div>
```

### Key Elements
- **Container**: `#floating-center-div` - Main modal container with fixed positioning
- **Close Button**: `#floating-center-div-right-close` - X button in top-right corner
- **Title**: `#floating-center-div-title` - Dynamic title display
- **Content**: `#floating-center-div-content` - Dynamic content area

## JavaScript API

### Core Functions (floating-div.js)

#### showFloatingDiv(title, contentHtml)
```javascript
function showFloatingDiv(title, contentHtml) {
    FloatingDivOpened = true;
    $('#floating-center-div').fadeIn();
    $('#floating-center-div-title').html(title);
    $('#floating-center-div-content').html(contentHtml);
}
```
- Sets global `FloatingDivOpened` flag to true
- Fades in the modal with jQuery
- Sets title and content HTML

#### hideFloatingDiv()
```javascript
function hideFloatingDiv() {
    FloatingDivOpened = false;
    $('#floating-center-div').fadeOut();
}
```
- Sets global `FloatingDivOpened` flag to false
- Fades out the modal

### Event Handlers

#### Close Button Click
```javascript
$('#floating-center-div-right-close').on('click', function() {
    hideFloatingDiv();
});
```

#### Escape Key Handler
```javascript
$(document).on('keydown', function(e) {
    if (e.key === "Escape" && FloatingDivOpened) hideFloatingDiv();
});
```

#### Form Submission Handler
```javascript
  $("#floating-center-div").on("submit", "#floating-center-div-form", function(e) {
    e.preventDefault();
    var title = $('#floating-center-div-title').html();
    var url = $('#floating-center-div-form').attr('action');

    $('#floating-center-div-title').html('Loading... Please wait...');
    $('#floating-center-div').css('background','#eee');

    var formData = {};
    $("#floating-center-div-form").serializeArray().forEach(function(item) {
        formData[item.name] = item.value;
    });

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        success: function(response) {
            $('#floating-center-div').css('background','#fff');
            showFloatingDiv(title, response);
        },
        error: function(xhr, status, error) {
            $('#floating-center-div').css('background','#fff');
            showFloatingDiv('Fatal error '+status, error);
        }
    });
  });
```

## AJAX Communication Pattern

### more_button_click() Function
```javascript
function more_button_click(id) {
    var object = dataset_values[id].object;
    var action = dataset_values[id].action;
    var step = dataset_values[id].step;
    var script='step'+step+'.php';
    var title = dataset_values[id].title;
    var subaction = dataset_values[id].subaction;
    if (subaction) {
        var url = '/ajax/'+object+'/'+action+'/'+subaction+'/'+script;
    } else {
        var url = '/ajax/'+object+'/'+action+'/'+script;
    }

    $('#floating-center-div-title').html('Loading... Please wait...');
    $('#floating-center-div').css('background','#eee');
    showFloatingDiv('Loading... Please wait...', '');

    $.ajax({
        url: url,
        type: 'POST',
        data: { dataset: dataset_values[id], token: GLOBAL.TOKEN },
        success: function(response) {
            $('#floating-center-div').css('background','#fff');
            showFloatingDiv(title, response);
        },
        error: function(xhr, status, error) {
            $('#floating-center-div').css('background','#fff');
            showFloatingDiv('Fatal error '+status, error);
        }
    });
}
```

### Usage Example
From [web/templates/user/list_web.html](mdc:web/templates/user/list_web.html) line 163:
```html
<div class="actions-panel__col actions-panel__logs" style="background-color: #c6d6d9;"><a href="javascript:void(0)" onclick="more_button_click(<?=$i?>)"><?=__('More')?> <i></i></a><span class="shortcut more">&nbsp;&#8629;</span></div>
```

### Parameters
- **id**: Index into dataset_values array

## Dataset Values System

### JavaScript Array Structure
From [web/templates/user/list_web.html](mdc:web/templates/user/list_web.html) lines 53-54 and 121-135:

```javascript
var dataset_values = [];

// Populated in loop for each domain
dataset_values[<?=$i?>] = {
    'object': 'web',
    'action': 'manage',
    'subaction': '',
    'step': '1',
    'title': '<?=$key?>',
    'domain': '<?=$key?>',
    'web_template': '<?=$data[$key]['TPL']?>',
    'proxy_template': '<?=$data[$key]['PROXY']?>',
    'backend_template': '<?=$data[$key]['BACKEND']?>',
    'ssl_support': '<?=$data[$key]['SSL']?>',
    'letsencrypt_support': '<?=$data[$key]['LETSENCRYPT']?>',
    'ip': '<?=$data[$key]['IP']?>'
};
```

### Data Structure
Each dataset entry contains:
- **object**: Module name (e.g., 'web', 'user', 'dns')
- **action**: Action name (e.g., 'manage', 'edit', 'delete')
- **subaction**: Action name (e.g., 'wordpress-lock', 'wordpress-unlock', 'wordpress-clone', '')
- **step**: Step number (1 for step1.php, 2 for step2.php, 3 dor step3.php, etc.)
- **title**: Title of modal dialog
- **domain**: Subject of module action, domain name
- other not mandatory variables

## AJAX Endpoint Structure

### File Organization
AJAX endpoints follow this pattern:
```
web/ajax/{object}/{action}/{script}
```

### Example: Web Management
- **Step 1**: [web/ajax/web/manage/index.php](mdc:web/ajax/web/manage/index.php)
- **Step 2**: [web/ajax/web/manage/step2.php](mdc:web/ajax/web/manage/step2.php)

### PHP Structure
```php
<?php

// Main include
$required_dataset_param = 'domain';
include($_SERVER['DOCUMENT_ROOT']."/ajax/authentication_check.php");

echo 'Ajax script: web / manage, step1, Domain: '.$domain;
?>

<br /><br />
<form id="floating-center-div-form" name="floating-center-div-form" method="post" action="/ajax/web/manage/step2.php">
    <input type="hidden" name="token" value="<?=$_SESSION['token']?>" />
    <input type="hidden" name="dataset[object]" value="<?=$_POST['dataset']['object']?>" />
    <input type="hidden" name="dataset[action]" value="<?=$_POST['dataset']['action']?>" />
    <input type="hidden" name="dataset[subaction]" value="<?=$_POST['dataset']['subaction']?>" />
    <input type="hidden" name="dataset[step]" value="2" />
    <input type="hidden" name="dataset[domain]" value="<?=$_POST['dataset']['domain']?>" />
    <input type="hidden" name="confirm_required" value="1" id="confirm_required" />

    <span class="ajax-label ajax-newline">Variable 1:</span>
    <input type="text" name="var1" value="val1" class="vst-input ajax-newline">
    <span class="ajax-label ajax-newline">Variable 2:</span>
    <input type="text" name="var2" value="val2" class="vst-input ajax-newline">
    <button type="submit" class="button ajax-button-margin-top">Submit</button>
</form>
```

## Key Patterns

### 1. Multi-Step Forms
- Step 1 (step1.php): Initial form with domain selection
- Step 2+ (stepN.php): Subsequent form steps
- Forms submit to next step via AJAX

### 2. CSRF Protection
- All forms include `token` hidden field
- If the form does not contain a `token` hidden field, then the token is passed in the AJAX `data` object.

### 3. Form ID Convention
- All forms in floating div must have ID: `floating-center-div-form`
- This enables automatic AJAX submission handling

### 4. Response Handling
- AJAX responses are displayed directly in floating div
- No page refresh required
- Maintains modal state across form steps

### 5. Global Variables
- `GLOBAL.TOKEN`: CSRF token for AJAX requests
- `FloatingDivOpened`: Boolean flag for modal state
- `dataset_values`: Array of object data for AJAX requests

## Implementation Guidelines

### Creating New AJAX Endpoints
1. Create directory structure: `web/ajax/{object}/{action}/`
2. Add `step1.php` for step 1
3. Add `step2.php`, `step3.php`, etc. for subsequent steps
4. Add required parameter (for example `$required_param = 'domain';`) and include `web/ajax/authentication_check.php` for security checks (`include($_SERVER['DOCUMENT_ROOT']."/ajax/authentication_check.php");`)
5. Use `floating-center-div-form` ID for forms
6. Include CSRF `token` in forms as hidden input element

### Adding More Buttons
1. Add button with `onclick="more_button_click(id)"`
2. Ensure `dataset_values[id]` contains required data
3. Create corresponding AJAX endpoint files

### Form Validation
- Validate POST data in PHP endpoints (`web/ajax/authentication_check.php` does essential security checks)
- Return error messages in HTML format for display

This system provides a consistent modal dialog experience across the myVesta web interface with seamless AJAX communication and multi-step form handling.