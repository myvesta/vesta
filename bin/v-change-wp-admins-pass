#!/bin/bash
# info: disinfect a WordPress site with several maintenance commands
# options: DOMAIN

#----------------------------------------------------------#
#                    Variable & Function                   #
#----------------------------------------------------------#

DOMAIN="$1"
VESTA="/usr/local/vesta"

# absolute paths to maintenance scripts
CHANGE_DB_PASS="/usr/local/vesta/bin/v-change-db-password-to-wordpress"
FIX_CORE="/usr/local/vesta/bin/v-fix-wp-core"
WF_SCAN="/usr/local/vesta/bin/v-wf-malware-hyperscan-with-remediate"
ADMIN_PASS="/usr/local/vesta/bin/v-change-wp-admins-pass"

TASKS=(
    "$CHANGE_DB_PASS"
    "$FIX_CORE"
    "$WF_SCAN"
    "$ADMIN_PASS"
)

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#
if [ "$(whoami)" != "root" ]; then
    echo "You must be root to run this command."
    exit 1
fi

if [ -z "$DOMAIN" ]; then
    echo "Usage: v-desinfect-wp DOMAIN"
    exit 1
fi

if ! "$VESTA/bin/v-search-domain-owner" "$DOMAIN" >/dev/null 2>&1; then
    echo "Domain $DOMAIN does not exist."
    exit 1
fi

#----------------------------------------------------------#
#                         Action                           #
#----------------------------------------------------------#

echo
read -r -p "Run all maintenance steps automatically? (y/n) " AUTO < /dev/tty
[[ "$AUTO" =~ ^[Yy]$ ]] && AUTOMATIC=true || AUTOMATIC=false

for CMD in "${TASKS[@]}"; do
    if [ ! -x "$CMD" ]; then
        echo "Command $CMD not found or not executable, skipping."
        continue
    fi

    if [ "$AUTOMATIC" = false ]; then
        while true; do
            read -r -p "Run $(basename "$CMD") for $DOMAIN? (y/n) " YN < /dev/tty
            case "$YN" in
                [Yy]* ) break ;;
                [Nn]* ) echo "Skipping $(basename "$CMD")."; continue 2 ;;
                * )     echo "Please answer y or n." ;;
            esac
        done
    fi

    echo
    echo "=== $(basename "$CMD") $DOMAIN ==="
    "$CMD" "$DOMAIN"
done

echo
echo "Done."
exit 0
